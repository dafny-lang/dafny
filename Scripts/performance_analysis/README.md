# Dafny Analysis Tools

A comprehensive toolkit for analyzing Dafny verification performance and solver behavior through automated data collection and statistical analysis.

## Project Snapshot Archive Format

The tools work with **project snapshot archives** - structured `.tar` files that package Dafny programs with their verification configurations for reproducible analysis.

### Archive Structure

```
my_project.tar
├── dfy-list                    # Index file listing programs and options
└── project/
    ├── def/
    │   ├── util.dfy            # Dafny source files
    │   ├── core.dfy
    │   └── ...
    ├── validation/
    │   ├── types.dfy
    │   └── ...
    └── theorems/
        └── ...
```

### `dfy-list` Format

The `dfy-list` file is a text file where each line specifies a Dafny program and its verification options:

**Simple format (no options):**
```
project/def/util.dfy
project/def/core.dfy
project/validation/types.dfy
project/theorems/basic.dfy
```

**With verification options:**
```
project/src/main/dafny/test/MainTest.dfy -warnShadowing -definiteAssignment:4 -vcsSplitOnEveryAssert -generalTraits:datatype -typeSystemRefresh:1 -proverOpt:BATCH_MODE=true -typeEncoding:a
project/src/main/dafny/lib/CommonTypes.dfy -warnShadowing -definiteAssignment:4 -vcsSplitOnEveryAssert -generalTraits:datatype -typeSystemRefresh:1 -proverOpt:BATCH_MODE=true -typeEncoding:a
```

**Format:** `<relative_path_to_dfy_file> [dafny_options...]`

**Note:** Only the old Dafny CLI is currently supported for the command-line options format.

### Generated Intermediate Files

During processing, the tools generate:

- **BPL files**: Boogie Procedure Language files from Dafny
- **SMT2 files**: SMT-LIB format files for Z3 solver analysis
- **Z3 trace logs**: Detailed solver execution traces

## Tools Overview

### 1. `dafny_gatherer.py` - Data Collection

Processes project snapshot archives to extract comprehensive verification statistics.

**Usage:**
```bash
python3 dafny_gatherer.py snapshot.tar [options]
```

**Common Options:**
```bash
# Basic usage with default settings
python3 dafny_gatherer.py my_snapshot.tar

# Custom configuration
python3 dafny_gatherer.py snapshot.tar \
    --seed 42 \
    --timeout 600 \
    --pool-size 8 \
    --working-dir /tmp/analysis \
    --z3-path /usr/local/bin/z3 \
    --no-cleanup
```

**Output:** `snapshot.csv` containing detailed statistics for each verification task.

### 2. `dafny_analyzer.py` - Data Analysis

Analyzes and compares CSV files generated by `dafny_gatherer.py`.

**Three Analysis Modes:**

#### Single File Analysis
```bash
python3 dafny_analyzer.py analyze results.csv [options]
```

**Features:**
- Quantifier instantiation (QI) pattern analysis
- Correlation matrix generation
- Performance metric visualization
- Top quantifier identification

**Options:**
- `--qi-count N`: Show top N quantifier patterns (default: 100)
- `--plot output.pdf`: Save visualizations to PDF
- `--interactive`: Show interactive plots

#### Comparative Analysis
```bash
python3 dafny_analyzer.py compare --a baseline/ --b experiment/
```

**Features:**
- Runtime performance comparison
- Regression detection (files that stopped working)
- Improvement/degradation statistics
- Performance distribution analysis

#### Benchmark Comparison
```bash
python3 dafny_analyzer.py compare-many --benchmark baseline.csv --dir iterations/
```

**Features:**
- Multi-iteration performance tracking
- Statistical analysis of changes over time
- Quantifier instantiation stability analysis
- Comprehensive performance summaries

## Installation Requirements

### Dependencies

```bash
# Python packages
pip install numpy matplotlib statistics

# External tools (must be in PATH or specify with --*-path options)
# Z3 SMT solver
# SMTscope profiler
# Dafny compiler
# Boogie verifier
```

### Tool Installation

1. **Z3**: Build from [Z3 repository](https://github.com/Z3Prover/z3)
2. **Dafny**: Build from [Dafny repository](https://github.com/dafny-lang/dafny)
3. **Boogie**: Build from [Boogie repository](https://github.com/boogie-org/boogie)
4. **SMTscope**: Build from [SMTscope repository](https://github.com/microsoft/SMTscope)

## Key Metrics Collected

### Z3 Solver Statistics
- **Conflicts**: Number of conflicts encountered
- **Decisions**: Number of decision points
- **Propagations**: Number of unit propagations
- **Restarts**: Number of solver restarts
- **Memory usage**: Peak memory consumption
- **Time**: Total solving time
- **Quantifier instantiations**: QI counts and patterns

### Profiler Statistics
- **Enodes**: Number of expression nodes
- **Given/Trans equalities**: Equality reasoning statistics
- **Instantiation breakdowns**: By category (MBQI, theory, axioms, etc.)
- **Node counts**: Various AST node statistics

### Derived Metrics
- **QI Concentration**: `qi_top / qi` - measures instantiation concentration
- **QI Dummy Concentration**: Similar for dummy instantiations
- **Runtime ratios**: Comparative performance metrics
- **Stability measures**: Quantifier ordering consistency

## Example Workflow

### 1. Create a Snapshot Archive
```bash
# Create dfy-list
echo "project/def/util.dfy" > dfy-list
echo "project/validation/types.dfy" >> dfy-list
echo "project/test/Main.dfy -vcsSplitOnEveryAssert -typeEncoding:a" >> dfy-list

# Create archive
tar -cf my_experiment.tar dfy-list project/
```

### 2. Collect Statistics
```bash
python3 dafny_gatherer.py my_experiment.tar --pool-size 4 --timeout 300
# Generates: my_experiment.csv
```

### 3. Analyze Results
```bash
# Single file analysis
python3 dafny_analyzer.py analyze my_experiment.csv --plot analysis.pdf

# Compare with baseline
python3 dafny_analyzer.py compare --a baseline/ --b experiment/
```